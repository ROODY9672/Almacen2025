@model SIGLA.Business.Dto.Usuariossss.UsuariosViewModelEditar



@{
    ViewData["Title"] = "Registrar Usuario";
}

@section VendorStyles {
    <link rel="stylesheet" href="~/vendor/libs/bootstrap-select/bootstrap-select.css" />
    <link rel="stylesheet" href="~/vendor/libs/flatpickr/flatpickr.css" />
    <link rel="stylesheet" href="~/vendor/libs/typeahead-js/typeahead.css" />
    <link rel="stylesheet" href="~/vendor/libs/tagify/tagify.css" />
    <link rel="stylesheet" href="~/vendor/libs/&#64;form-validation/form-validation.css" />
    <link rel="stylesheet" href="~/vendor/libs/toastr/toastr.css" />
    <link rel="stylesheet" href="~/vendor/libs/animate-css/animate.css">

    <link rel="stylesheet" href="~/vendor/libs/quill/typography.css">
    <link rel="stylesheet" href="~/vendor/libs/quill/katex.css">
    <link rel="stylesheet" href="~/vendor/libs/quill/editor.css">
    <link rel="stylesheet" href="~/vendor/libs/select2/select2.css">
    <link rel="stylesheet" href="~/vendor/libs/dropzone/dropzone.css">




}

@section VendorScripts {
    <script src="~/vendor/libs/bootstrap-select/bootstrap-select.js"></script>
    <script src="~/vendor/libs/moment/moment.js"></script>
    <script src="~/vendor/libs/flatpickr/flatpickr.js"></script>
    <script src="~/vendor/libs/typeahead-js/typeahead.js"></script>
    <script src="~/vendor/libs/tagify/tagify.js"></script>
    <script src="~/vendor/libs/&#64;form-validation/popular.js"></script>
    <script src="~/vendor/libs/&#64;form-validation/bootstrap5.js"></script>
    <script src="~/vendor/libs/&#64;form-validation/auto-focus.js"></script>
    <script src="~/vendor/libs/toastr/toastr.js"></script>

    <script src="~/vendor/libs/quill/katex.js"></script>
    <script src="~/vendor/libs/quill/quill.js"></script>
    <script src="~/vendor/libs/select2/select2.js"></script>
    <script src="~/vendor/libs/dropzone/dropzone.js"></script>
    <script src="~/vendor/libs/jquery-repeater/jquery-repeater.js"></script>

}





<div class="row gy-12">

    <div class="col-xl-12">
        <h6 class="text-muted">Usuarios  </h6>
        <div class="card text-center mb-4">
            <div class="card-header p-0">
                <div class="nav-align-top">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link d-flex flex-column gap-1 active border-bottom border-primary text-primary"
                               href="@Url.Action("ListadoUsuariosSucursales", "UsuariosCore")" role="tab">
                                <i class="tf-icons ri-list-check"></i>
                                <span>Listado</span>
                            </a>
                        </li>

                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div class="tab-content pb-0">
                    <div class="tab-pane fade show active" id="navs-home-card" role="tabpanel">

                        <h5 class="card-header ">
                            <i class="ri-shield-user-line text-primary fs-4"></i>
                            Editar Usuario
                        </h5>





                        <div class="card-body">
                            @using (Html.BeginForm("Registrar", "Usuariossss", FormMethod.Post, new { id = "formUsuario" }))
                            {

                                @Html.HiddenFor(m => m.centroControl.UsuarioNo, new { @class = "form-control", placeholder = "UsuarioNo", id = "UsuarioNo" })

                                <div class="row g-4">
                                    <!-- Campo Nombre Usuario con ícono de usuario -->
                                    <div class="col-md-6">
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="ri-user-line"></i></span>
                                            <div class="form-floating form-floating-outline flex-grow-1">
                                                @Html.TextBoxFor(m => m.centroControl.NombreUsuario, new
                                                    {
                                                        @class = "form-control",
                                                        placeholder = "Nombre Usuario",
                                                        id = "NombreUsuario"
                                                    })
                                                <label for="NombreUsuario">Nombre Completo</label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Campo Apellido Paterno con ícono de usuario -->
                                    <div class="col-md-6">
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="ri-user-line"></i></span>
                                            <div class="form-floating form-floating-outline flex-grow-1">
                                                @Html.TextBoxFor(m => m.centroControl.ApellidoPaterno, new
                                                    {
                                                        @class = "form-control",
                                                        placeholder = "Apellido Paterno",
                                                        id = "ApellidoPaterno"
                                                    })
                                                <label for="ApellidoPaterno">Apellido Paterno</label>
                                            </div>
                                        </div>
                                    </div>


                                    <!-- Campo Apellido Materno con ícono de usuario -->
                                    <div class="col-md-6">
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="ri-user-line"></i></span>
                                            <div class="form-floating form-floating-outline flex-grow-1">
                                                @Html.TextBoxFor(m => m.centroControl.ApellidoMaterno, new
                                                    {
                                                        @class = "form-control",
                                                        placeholder = "Apellido Materno",
                                                        id = "ApellidoMaterno"
                                                    })
                                                <label for="ApellidoMaterno">Apellido Materno</label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Campo Número de Documento con ícono de identificación -->
                                    <div class="col-md-6">
                                        <div class="input-group input-group-merge">
                                            <span class="input-group-text"><i class="ri-id-card-line"></i></span>
                                            <div class="form-floating form-floating-outline flex-grow-1">
                                                @Html.TextBoxFor(m => m.centroControl.NumeroDocumento, new
                                                    {
                                                        @class = "form-control",
                                                        placeholder = "Número de Documento",
                                                        id = "NumeroDocumento"
                                                    })
                                                <label for="NumeroDocumento">Número de Documento</label>
                                            </div>
                                        </div>
                                    </div>



                                    <div class="col-md-6">
                                        <div class="form-floating form-floating-outline">
                                            @Html.DropDownListFor(m => m.centroControl.Sexo,
                                                     new SelectList(new[]
                                                     {
                                        new { Value = "", Text = "-- SELECCIONE --" },
                                        new { Value = "Masculino", Text = "Masculino" },
                                        new { Value = "Femenino", Text = "Femenino" }
                                        }, "Value", "Text", Model.centroControl.Sexo),
                                                     new { @class = "form-select", id = "Sexo" })
                                            <label for="Sexo">Sexo</label>
                                        </div>
                                    </div>


                                    <br />
                                    <hr />

                                   



                                    



                                    <div class="col-md-6">
                                        <div class="form-floating form-floating-outline">
                                            @Html.DropDownListFor(m => m.centroControl.Rol,
                                                     new SelectList(new[]
                                                     {
                                        new { Value = "", Text = "-- SELECCIONE --" },
                                        new { Value = "Administrador", Text = "Administrador" },
                                        new { Value = "Almacenero", Text = "Almacenero" },
                                        new { Value = "Vendedor", Text = "Vendedor" }
                                        }, "Value", "Text", Model.centroControl.Rol),
                                                     new { @class = "form-select", id = "Rol" })
                                            <label for="Rol">Rol Usuario</label>
                                        </div>
                                    </div>


 
                                    <hr />






                                    <!-- Media -->
                                    <div class="card mb-6">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0 card-title">Foto del Usuario</h5>
                                        </div>
                                        <div class="card-body">
                                            <!-- Usamos DIV en lugar de FORM porque ya estamos dentro de otro formulario -->
                                            <div action="/upload" class="dropzone needsclick" id="FotoPersona">
                                                <div class="dz-message needsclick">
                                                    <div class="d-flex justify-content-center">
                                                        <div class="avatar avatar-md">
                                                            <span class="avatar-initial rounded bg-label-secondary">
                                                                <i class="ri-upload-2-line ri-24px"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <p class="h4 needsclick my-2">Arrastra tu imagen aquí</p>
                                                    <small class="text-muted d-block fs-6 my-2">o</small>
                                                    <span class="needsclick btn btn-sm btn-outline-primary" id="btnBrowse">Seleccionar imagen</span>
                                                </div>
                                                <div class="fallback">
                                                    <input name="fileInput" id="fileInput" type="file" accept="image/*" />

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <!-- /Media -->








                                    <hr />










                                    <div class="col-12">
                                        <label class="form-label">Empresa </label>
                                        <div class="row" id="contenedorTarjetasSucursal">
                                            @foreach (var item in Model.Sucursales)
                                            {
                                                var estaSeleccionado = Model.SucursalesAsignadas.Contains(item.SucursalNo);
                                                <!-- Validación -->

                                                <div class="col-md mb-md-0 mb-4">
                                                    <div class="form-check custom-option custom-option-icon">
                                                        <label class="form-check-label custom-option-content" for="sucursal_@item.SucursalNo">
                                                            <span class="custom-option-body">
                                                                <img src="~/img/icons/unicons/Tienda.png" class="w-px-40 mb-2" alt="chart" />
                                                                <span class="custom-option-title mb-2">@item.Sede</span>
                                                                <span class="custom-option-title mb-2">@item.NombreSucursal</span>
                                                                <small class="text-muted">@item.Direccion</small>
                                                            </span>
                                                            <input class="form-check-input"
                                                                   type="checkbox"
                                                                   name="SucursalesSeleccionadas"
                                                                   value="@item.SucursalNo"
                                                                   id="sucursal_@item.SucursalNo"
                                                            @(estaSeleccionado ? "checked" : "") />
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>



                                    <hr />


                                    <div class="col-12 text-center">
                                        <button type="button" class="btn btn-primary" id="btnActualizarUsuario">
                                            <i class="ri-refresh-line"></i> Actualizar
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- Tabs -->
@section PageScripts {
    @*  <script src="~/js/form-validation.js"></script> *@
    <script src="~/js/ui-toasts.js"></script>
    <script src="~/js/app-ecommerce-product-add.js"></script>






    <script>


             $(function () {
            $('#btnActualizarUsuario').on('click', function (e) {
                e.preventDefault();

                var $btn = $(this);
                $btn.prop('disabled', true);

                if (!validarCamposUsuario()) {
                    $btn.prop('disabled', false);
                    return;
                }

                var formData = new FormData();
                formData.append('centroControl.UsuarioNo', $('#UsuarioNo').val()); // Asegúrate que este campo exista
                formData.append('centroControl.NombreUsuario', $('#NombreUsuario').val().trim());
                formData.append('centroControl.ApellidoPaterno', $('#ApellidoPaterno').val().trim());
                formData.append('centroControl.ApellidoMaterno', $('#ApellidoMaterno').val().trim());
                formData.append('centroControl.NumeroDocumento', $('#NumeroDocumento').val().trim());
                formData.append('centroControl.Sexo', $('#Sexo').val());
                formData.append('centroControl.Rol', $('#Rol').val());

                $('input[name="SucursalesSeleccionadas"]:checked').each(function () {
                    formData.append('SucursalesSeleccionadas', $(this).val());
                });

                if (dropzoneFotoPersona.files.length > 0) {
                    formData.append('fileInput', dropzoneFotoPersona.files[0]);
                }

                $.ajax({
                    url: '@Url.Action("ActualizarUsuario", "UsuariosCore")',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data.success) {
                            toastr.success("Usuario actualizado correctamente");
                            setTimeout(function () {
                                location.reload();
                            }, 2000);
                        } else {
                            toastr.error(data.error || "Error al actualizar el usuario.");
                            $btn.prop('disabled', false);
                        }
                    },
                    error: function () {
                        toastr.error("Error en el servidor");
                        $btn.prop('disabled', false);
                    }
                });
            });
        });







                function validarCamposUsuario() {
            let errores = false;

            var nombre = $('#NombreUsuario').val().trim();
            
            var rol = $('#Rol').val();
            var sucursalesSeleccionadas = $('input[name="SucursalesSeleccionadas"]:checked');
            var apellidoPaterno = $('#ApellidoPaterno').val().trim();
            var apellidoMaterno = $('#ApellidoMaterno').val().trim();
            var numeroDocumento = $('#NumeroDocumento').val().trim();
            var sexo = $('#Sexo').val();

            if (nombre === "") {
                toastr.warning("Nombre de usuario es obligatorio", "Advertencia");
                errores = true;
            }
            if (apellidoPaterno === "") {
                toastr.warning("Apellido paterno es obligatorio", "Advertencia");
                errores = true;
            }
            if (apellidoMaterno === "") {
                toastr.warning("Apellido materno es obligatorio", "Advertencia");
                errores = true;
            }
            if (numeroDocumento === "") {
                toastr.warning("Número de documento es obligatorio", "Advertencia");
                errores = true;
            }
            if (sexo === "") {
                toastr.warning("Debe seleccionar el sexo", "Advertencia");
                errores = true;
            }
            
           
            if (rol === "") {
                toastr.warning("Debe seleccionar un rol", "Advertencia");
                errores = true;
            }
            if (sucursalesSeleccionadas.length === 0) {
                toastr.warning("Debe seleccionar al menos una empresa", "Advertencia");
                errores = true;
            }

            return !errores;
        }




      






    </script>






    <script>
             Dropzone.autoDiscover = false;

        const previewTemplate = `
        <div class="dz-preview dz-file-preview">
          <div class="dz-details">
            <div class="dz-thumbnail">
              <img data-dz-thumbnail />
              <span class="dz-nopreview">No preview</span>
              <div class="dz-success-mark"></div>
              <div class="dz-error-mark"></div>
              <div class="dz-error-message"><span data-dz-errormessage></span></div>

            </div>
            <div class="dz-filename" data-dz-name></div>
            <div class="dz-size" data-dz-size></div>
          </div>
        </div>
        `;

        const dropzoneFotoPersona = new Dropzone("#FotoPersona", {
          previewTemplate: previewTemplate,
          maxFiles: 1,
          maxFilesize: 5,
          acceptedFiles: ".jpg,.jpeg,.png,.gif",
          addRemoveLinks: true,
          autoProcessQueue: false
        });





    </script>







}
